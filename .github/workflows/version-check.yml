name: Version Consistency Check

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  version-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦ã‚¿ã‚°æƒ…å ±ã‚’å‚ç…§
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.20'
    
    - name: Get latest git tag
      id: git-tag
      run: |
        LATEST_TAG=$(git tag --sort=-version:refname | head -n1)
        if [ -z "$LATEST_TAG" ]; then
          LATEST_TAG="v0.0.0"
        fi
        echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "Latest git tag: $LATEST_TAG"
    
    - name: Check version setup
      id: version-setup
      run: |
        echo "â„¹ï¸ Version is now managed dynamically via internal/version package"
        echo "main.go uses: version.GetVersion()"
        echo "MCP client uses: version.GetMCPVersion()"
        echo "Actual version is injected at build time via ldflags"
        echo "setup=dynamic" >> $GITHUB_OUTPUT
    
    - name: Check version consistency
      run: |
        GIT_TAG="${{ steps.git-tag.outputs.tag }}"
        SETUP="${{ steps.version-setup.outputs.setup }}"
        
        echo "ğŸ” Version Management Validation"
        echo "Git tag: $GIT_TAG"
        echo "Version setup: $SETUP"
        echo
        
        # å‹•çš„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®æ¤œè¨¼
        if [ "$SETUP" = "dynamic" ]; then
          echo "âœ… Using dynamic version management system"
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å­˜åœ¨ç¢ºèª
          if [ ! -f "internal/version/version.go" ]; then
            echo "âŒ Version package not found"
            exit 1
          fi
          
          # main.goã§é©åˆ‡ãªé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
          if ! grep -q "version.GetVersion()" cmd/vyb/main.go; then
            echo "âŒ main.go not using version.GetVersion()"
            exit 1
          fi
          
          # MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§é©åˆ‡ãªé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
          if ! grep -q "version.GetMCPVersion()" internal/mcp/client.go; then
            echo "âŒ MCP client not using version.GetMCPVersion()"
            exit 1
          fi
          
          # ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ldflagsè¨­å®šã‚’ç¢ºèª
          if ! grep -q "internal/version.Version" scripts/build.sh; then
            echo "âŒ Build script not configured for version injection"
            exit 1
          fi
          
          echo "âœ… All version management components are properly configured"
        else
          echo "âŒ Unexpected version setup: $SETUP"
          exit 1
        fi
    
    - name: Version management troubleshooting
      if: failure()
      run: |
        echo "ğŸ’¡ Dynamic Version Management Troubleshooting:"
        echo "1. Ensure internal/version/version.go exists with proper structure"
        echo "2. Verify main.go uses version.GetVersion()"
        echo "3. Verify MCP client uses version.GetMCPVersion()" 
        echo "4. Check scripts/build.sh has correct ldflags configuration"
        echo "5. Version is injected at build time, not hardcoded"